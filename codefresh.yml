version: '1.0'
steps:
  TagReleaseName:
    title: Setup RELEASE_NAME variable with tag
    image: alpine/git
    when:
      condition:
        all:
          releaseNameNotDefined: "${{TAG_REPO}} == true"
    commands:
      - cf_export RELEASE_NAME=${{TAG_NAME}}

  BranchReleaseName:
    title: Setup RELEASE_NAME variable with branch name
    image: alpine/git
    when:
      condition:
        all:
          releaseNameNotDefined: "${{TAG_REPO}} == false"
    commands:
      - cf_export RELEASE_NAME=${{GLOBAL_RELEASE_VERSION}}.${{CF_BRANCH_TAG_NORMALIZED}}

  Build:
    title: Maven build
    fail_fast: false
    image: r.cfcr.io/regnosysops/regnosys/mvn-docker-build:java-8
    working_directory: ./
    commands:
      - rm -rf /codefresh/volume/.m2/com/regnosys
      - mvn -s /settings.xml versions:set -DnewVersion=${{RELEASE_NAME}}
      - mvn -s /settings.xml versions:update-property -Dproperty=rosetta.workbench.version -DnewVersion=[${{RELEASE_NAME}}] -DallowSnapshots=true -DallowDowngrade=true
      - mvn -U -s /settings.xml clean deploy

  Slack_notify:
    title: Notify Slack channel if master failed
    image: tutum/curl
    when:
      branch:
        only:
          - codefresh_steps
      condition:
          buildFailed: Build.result == 'failure'
    commands:
       - echo  ${{CF_COMMIT_AUTHOR}} && echo  ${{CF_REPO_OWNER}}  && echo  ${{CF_REPO_NAME}} 
       - echo  ${{CF_BUILD_INITIATOR}} &&  echo ${{CF_COMMIT_MESSAGE}} 
       - curl -X POST --data-urlencode 'payload={"text":"Test slack integration via yaml for ${{CF_COMMIT_AUTHOR}}"}' ${{SLACK_CF}}

  TagRepo:
    title: Tag git repo with release name
    image: alpine/git
    when:
      condition:
        all:
          isRelease: "${{TAG_REPO}}"
          myCondition: Build.result == 'success'
    commands:
      - echo This is a release build, tag repos with release name [${{RELEASE_NAME}}]
      - git fetch --prune https://regnosys-ops:O6pl6qXtQLk6Z8KO2QFEcY@github.com/REGnosys/${{CF_REPO_NAME}}.git "+refs/tags/*:refs/tags/*"
      - git tag ${{RELEASE_NAME}}
      - git push https://regnosys-ops:O6pl6qXtQLk6Z8KO2QFEcY@github.com/REGnosys/${{CF_REPO_NAME}}.git ${{RELEASE_NAME}}


  StartNextBuild:
    title: Build rosetta-components if on master
    image: codefresh/cli
    when:
      branch:
        only:
          - master
      condition:
        all:
          variableDefined: "${{TAG_REPO}} == false"
          skipNextBuild: "{{SKIP_NEXT_BUILD}} == false"
          myCondition: Build.result == 'success'
    commands:
      - codefresh run REGnosys/rosetta-components/rosetta-components --branch master --detach
